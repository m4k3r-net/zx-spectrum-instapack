                                                        -= 1 =-
(C) MicroArt
(C) MaxSoft 1995

                                            Персональный компьютер TURBO 2+
                                                 Платы версии 7.00-7.10
                                    Техническое описание и руководство программиста.

                                        Структура памяти и портов ввода вывода.

                                                   1. Системный порт

                                                   Адрес доступа: #77
                                       Выборка:A0=1,A1=1,A2=1,A3=0,A4=1,A7=0,WR=0

Обращение к этому порту осуществляется в режиме dosen=on или из режима CP/M.

D0 - RG0  \
D1 - RG1   - код видеорежима
D2 - RG2  /
D3 - TUR  Частота процессора 1-7MHz 0-3.5MHz
D4 - Z_M  зарезервировано - необходимо устанавливать в 0
D5 - Z_I прерывания от HSYNC (50 гц) 1-разрешены 0- запрещены
D6 - VE1 1-запрет функционирования 8031 (все запросы идут к zx клавиатуре)
D7 - VE0 в плате 7.10 не используется (по умолчанию необходимо устанавливать в 1)
A8 - PEN 0 - откл. диспетчера памяти (системное пзу включается во все окна), 1 - вкл. диспетчера памяти.
A9  -  CPM  0  -  включение  dosen  разрешение  записи  в  порт  страниц,SYS  ets.  1 - блокировка dosen (запись в порты
sys,pgwr,fdd,hdd только из TR-DOS)
A14- PEN2 0 - разрешение записи палитры,1 -запрет записи палитры

; Видеорежимы экрана RG2&RG1&RG0
;Sinclair      3
;640x200 GRAPH 2
;320x200 GRAPH 0
;640x200 Text  6

   Программистам необходимо помнить, что при переключении из режима Sinclair экрана и экранов высокого разрешения, пере-
путывается  адресное пространство озу а именно A5,A6,A7 и A8,A9,A10 соответственно т.е. если вы хотите переключить режим
экрана  -  программа  переключения  должна  занимать не более 32 байт и располагаться по адресу с одинаковыми A5,A6,A7 и
A8,A9,A10 соответственно, иначе ваша программа зависнет!


                                                2. Мультиплексор страниц

                                                   Адрес доступа: #F7
                                       Выборка:A0=1,A1=1,A2=1,A3=0,A4=1,A7=1,WR=0

   Обращение к этому порту осуществляется в режиме dosen-active или из режима CPM. Применение диспетчера позволило адре-
совать в компьютере до 1024кб RAM и 1024кб ROM. При этом есть возможность включить _ЛЮБУЮ_ страницу памяти (16кб) в _ЛЮ-
БОЕ_ из четырех окон памяти (с адреса: #0000,#4000,#8000,#C000) по 16кб. Диспетчер разделен на две части по 4 байта каж-
дая. Эти части содержат карту страниц при ROM2=0 и при ROM2=1.

D0 - RAM&ROM invert PAGE 0\
D1 - RAM&ROM invert PAGE 1 \
D2 - RAM&ROM invert PAGE 2  \инверсный номер страницы
D3 - RAM&ROM invert PAGE 3  /
D4 - RAM&ROM invert PAGE 4 /
D5 - RAM&ROM invert PAGE 5/
D6 - RAM/ROM 1-разрешение RAM,0-ROM
D7 - MX_A 1-разрешить подачу сигналов (PAGE0-PAGE2) от порта #7FFD
A14 - window sel 0\  выборка окна 0-#0000 1-#4000 2-#8000
A15 - window sel 1/                               3-#C000

                     Cтандартная карта распределения памяти в различных режимах работы компьютера:

                             ┌─────┬────────────┬───────────┬────────┬──────────┬─────────┐
                             │mode │Spectrum-128│Spectrum-48│ TR-DOS │CPM-system│CPM-users│
                             │roms │   ROM2=1   │  ROM2=0   │ ROM2=x │  ROM2=1  │  ROM2=0 │
                             ├─────┼────────────┼───────────┼────────┼──────────┼─────────┤
                             │#0000│   ROM-#3E  │  ROM-#3C  │ ROM-#3D│  ROM-#3F │  RAM-0  │
                             │#4000│   RAM-5    │  RAM-5    │ RAM-5  │  RAM-5   │  RAM-4  │
                             │#8000│   RAM-2    │  RAM-2    │ RAM-2  │  RAM-2   │  RAM-2  │
                             │#C000│     см. состояние порта #7FFD   │RAM-1или 3│  RAM-3  │
                             └─────┴────────────┴───────────┴────────┴──────────┴─────────┘
В  режиме  ZX-SPECTRUM в окне с адреса #C000 может быть включена любая страница с 0 по 7 (это зависит от cостояния порта
#7FFD)

CPM-system -режим когда активно пзу с монитором (работа с экраном стандартные процедуры ввода/вывода с дисков,опрос кла-
виатуры, прерывания)

CPM-users -режим когда активна программа пользователя (в окне 0 - страница 0 озу)

                                                        -= 2 =-

   Примечание для любителей использовать все 1024к оперативки в SPECTRUM режиме.
Ниже приводится стандартная процедура переключения страниц 1024 к для SPECTRUM.
 При  вызове  в A номер страницы 0-3FH (необходимо помнить что стек и вызывающая программа не должны находится в адресах
выше #C000)

SET_PAGE:
        PUSH AF
        AND 7          ;выделяем младшие 3 бита
        OR #10         ;по усмотрению можно выбрать пзу и экран.
        LD BC,#7FFD
        OUT (C),A
        POP AF
        AND     #38        ;маскируем все биты кроме 3х старших
        CPL                ;инверсия данных
                           ;(бит выборки озу взводится)
        LD      BC,#2A53   ;в TR-DOS - OUT (C),A RET
        PUSH    BC
        LD      BC,#FFF7
        JP      #3D2F      ;переход в TR-DOS

После любой подобной команды порт #7FFD отключается.
Если вы хотите корректно вернутся в SPECTRUM режим - выполните:

EXIT_1024:
        LD      A,#FF
        LD      BC,#2A53
        PUSH    BC
        LD      BC,#FFF7
        JP      #3D2F
дальнейшее управление страницами как обычно по порту #7FFD

                                             3. SPECTRUM-128 Системный порт

                                                  Адрес доступа: #7FFD
                                              Выборка:A15=0,A9=1,A1=0,WR=0

   Этот  порт  используется,  в  основном,  в режиме SPECTRUM-128, однако в CP/M он нужен для быстрой смены карты памяти
CPM-system<>CPM-users. Разработчики пытались сделать это место как можно более совместимым с фирменным ZX, однако это не
совсем удалось (см. главу "аппаратные ошибки").

D0-PAGE0  \
D1-PAGE1   определяют какая страница впечатана в режиме
D2-PAGE2  /  Spectrum-128 c адреса #C000
D3-SCREEN - этот разряд определяет в какой странице будет находиться экранное озу.
  в  режиме  "SPECTRUM":  0 - 5-я страница (с адреса #4000)
                          1 - 7-я страница.
  в режиме CP/M: 0 - 5-я страница пикселы, 1-я атрибуты
                 1 - 7-я страница пикселы, 3-я атрибуты
D4-ROM2 - этот сигнал путем переключения диспетчера выбирает BASIC-128 (1) или BASIC-48 (0). В CP/M переключает CPM-sys-
tem (1) или CPM-user (0)
D5-LOCK - записав в этот разряд "1", мы запрещаем дальнейшую работу с портом #7FFD (это сделано для полной совместимости
с SPECTRUM-48).

                                                4. Порт телефонной линии

                                                  Адрес доступа: #7FFD
                                              Выборка:A15=0,A9=1,A1=0,RD=0

                                      Порт #7FFD доступен по чтению как флаговый.

D7 - готовность ацп: 1 - ацп готово, 0 - идет преобразование данных.
D6 - 1 указывает, что HDD закончил выполнение последней команды (позиционирование,запись и.т.п.)
D5 - в плате версии 7.0 не задействован
D4 - в плате версии 7.0 не задействован

                                                   5. Порт чтения ацп

                                                  Адрес доступа:#7DFD
                                              Выборка:A15=0,A9=0,A1=0,RD=0

   Используется для чтения состояния АЦП. (Данные достоверны только в состоянии АЦП "готово" (см. выше).

                                           6. Порты музыкального синтезатора

                                               Адрес доступа:#BFFD,#FFFD
                                                Выборка:A15=1,A9=1,A1=0

   Используются для программирования музыкального синтезатора AY-8910(12).

                                                        -= 3 =-

                                                7. Порт принтера и цап.

                                                   Адрес доступа:#FB
                                                 Выборка:A0=1,A1=1,A2=0

   На  плате  реализован стандартный интерфейс CENTRONIX. Он не требует никакой предварительной инициализации. По чтению
этот порт копирует состояние сигнала BUSY принтера в BIT 7 аккумулятора.

Стандартный драйвер вывода на принтер символа из регистра C.

OUT_PRN: IN      A,(#FB)
         RLCA
         RET     C       ;C FLAG=1 возврат (принтер не готов)
         LD      A,C
         OUT     (#FB),A ;выводим данные
         OUT     (#7B),A ;импульс строб
         OUT     (#FB),A ;сброс строба
         RET             ;C FLAG=0  байт послан

   Необходимо помнить что к этому-же порту подключен цифро-аналоговый преобразователь.

                                                    8. MISC I/O PORT

                                                   Адрес доступа:#FA
                                                 Выборка:A0=0,A1=1,A2=0

   Стробы  IOWR,  IORD  этого  порта  выведены на системный разъем компьютера. С помощью этого порта и порта CENTRONIX к
компьютеру можно подключить 256 устройств ввода и 256 устройств вывода при сохранении полной совместимости с оригиналом.
При  этом,  адрес  порта записывается в CENTRONIX по команде OUT (#FB),A, а данные считываются по команде IN A,(#FA) или
записываются  по команде OUT (#FA),A. Шина данных на разъеме буферизирована. Для сохранения совместимости все новые раз-
работки рекомендуется подключать, используя исключительно этот порт.

                                                   9. Порт атрибутов

                                                   Адрес доступа:#FF
                             Выборка:A0=1,A1=1,A2=1,A3=1,A4=1,A5=1,A6=1,A7=1,DOSEN=OFF,RD=0

   Этот порт позволяет прочитать текущий, выводимый на экран атрибут.

                                                  10. Порт клавиатуры

                                                   Адрес доступа:#FE
                                              Выборка:A0=0,A1=1,A2=1,RD=0

   Про  этот порт следует рассказать подробнее. В стандартном режиме (без IBM клавиатуры) этот порт имеет следующее наз-
начение.

D0 - KD1\
D1 - KD2 \
D2 - KD3  клавиатурные входы данных
D3 - KD4 /
D4 - KD5/
D5  - Z системный сигнал от ПЛМ, На этом сигнале построена защита от копирования плат. Сигнал активизируется через опре-
деленное количество тактов после прихода прерывания (точно не помню какое). Программа, подсчитывая это количество, полу-
чает байт, который является ключем распаковки BIOS и BDOS... но в последней версии с 8031 от этого отказались.
D6 - TIN сигнал чтения с магнитофона.
D7 - не используется

A8  - KA0\
A9  - KA1 \
A10 - KA2  \
A11 - KA3   \ адресные линии клавиатуры
A12 - KA4   /
A13 - KA5  /
A14 - KA6 /
A15 - KA7/

   Начиная  с версии 7.00, в компьютере появилась мс. 8031, что кардинально изменило работу порта #FE и дало возможность
подключить IBM XT клавиатуру.

   При  попытке  прочитать содержимое клавиатуры, процессор дает команду IN A,(#FE), взводится спец. триггер и процессор
останавливается  сигналом  WAIT.  При  этом  в микроконтроллере 8031 генерируется прерывание. После необходимых процедур
трансляции  адресных линий, микроконтроллер выдает на шину данных процессора состояние клавиатуры, сигнал WAIT сбрасыва-
ется и процессор продолжает свою работу.
   Наличие  8031  и  расширенной клавиатуры (101 клавиша) позволило упростить опрос клавиатуры в CP/M до простого чтения
кода  клавиши,  однако, это потребовало введения дополнительных команд для управления 8031, и поскольку единственно воз-
можный  способ  передать  данные  в 8031, это состояние старшей половины шины адреса Z80 в момент чтения порта #FE, этот
способ и используется.

                                                        -= 4 =-

         Управляющие последовательности клавиатуры:

        _#55_  -  указывает, что следующий байт является кодом команды для клавиатуры. В ответ клавиатура возвращает код
#AA - это можно использовать для проверки наличия 8031.

  LD    A,#55
  IN    A,(#FE)
  CP    #AA
  JR    NZ,NO_XT
  LD    A,COMM   ;команда (см ниже)
  IN    A,(#FE)
  LD    A,ARG1   ;дополнительные параметры (могут отсутствовать)
  IN    A,(#FE)
  LD    A,ARG2   ;дополнительные параметры (могут отсутствовать)
  IN    A,(#FE)


        _#00_  - Читает код нажатой клавиши.

  XOR     A
  IN      A,(#FE)
  ;в аккумуляторе код клавиши (список кодов приводится ниже)

        _#80_  - читает 1-й байт флагов клавиатуры
        LD      A,#80
        IN      A,(#FE)

        _#40_  - читает 2-й байт флагов клавиатуры
        LD      A,#40
        IN      A,(#FE)

   Коды  команд (Внимание! Перед записью кода команды необходимо дать упр. код _#55_ для перевода 8031 в режим ввода ко-
манды):

1         получить 1 байт номера версии программы
#41       получить 2 байт номера версии программы
#81       получить 3 байт номера версии программы
#C1       получить 4 байт номера версии программы
7         стереть буфер клавиатуры и все флаги
8 DATA    установка режима работы:
         bit 0,1 - устанавливается режим работы
           0 - эмуляция синклер клавиатуры
           1 - чтение кода клавиши (флаги не обрабатываются)
           2 - режим CP/M
           3 - прямое чтение кода с последовательного порта
               клавиатуры
          bit 7 - режим 0-lat 1-rus (только для CP/M)

9         получить содержимое ячейки памяти 1
#49       получить содержимое ячейки памяти 2
#89       получить содержимое ячейки памяти 3
#C9       получить содержимое ячейки памяти 4
#0A       переключится в режим ввода русских букв
#0B       переключится в режим ввода латинских букв
#0C       программная пауза
#0D       перезапуск компьютера
#10       получить секунды
#50       получить минуты
#90       получить часы
#11 DATA  установить секунды
#51 DATA  установить минуты
#91 DATA  установить часы
#12       получить число
#52       получить месяц
#92       получить год
#13 DATA  установить число
#53 DATA  установить месяц
#93 DATA  установить год
#14 DATA  принудительно устанавливает некоторые сигналы
      (установка происходит если соответствующий бит равен 1)
          bit 0 = 0
          bit 1 = 0
          bit 2 = 0
          bit 3 DTR
          bit 4 RTI
          bit 5 = 0
          bit 6 = 0
          bit 7 = 0

                                                        -= 5 =-

#15 DATA принудительно сбрасывает некоторые сигналы (сброс происходит, если соответствующий бит равен 1 (см. ком #14)

#16       прочитать содержимое порта P3
          bit 0  -
          bit 1  -
          bit 2  -
          bit 3  -
          bit 4  VE1
          bit 5  -
          bit 6  -
          bit 7  -

#17       прочитать состояние RS232
          bit 0  CD
          bit 1  CTS
          bit 2  RI
          bit 3  -
          bit 4  -
          bit 5  -
          bit 6  -
          bit 7  -

                                                    11. Порт бордюра

                                                   Адрес доступа:#FE
                                              Выборка:A0=0,A1=1,A2=1,WR=0

   Этот порт несколько отличается от стандартного SPECTRUM. Дело в том что в CP/M бордюр (как и экран) может иметь любой
из  шестнадцати  цветов (из палитры 64). Поэтому потребовался дополнительный бит цвета, который был заведен на инверсный
A3.

D0 - BRD0\
D1 - BRD1 цвет бордюра
D2 - BRD2/
D3 - TAPEOUT Выход на магнитофон
D4 - SOUND   Выход на динамик
D5 - не используется
D6 - не используется
D7 - не используется
A3 - BRD3 - 3-й бит цвета (инверсный)

                                                Аппаратные ошибки платы.

   Основная  ошибка  -  использование  при дешифрации порта #7FFD и портов муз.процессора адреса A9. Из за этого не идут
следующие программы:

STS debuger-monitor,
SHOCK MEGADEMO,
игрушка RONDLAND,
ASM v1.03,
FARLIGHT-2

...и многие другие игрушки и программы, содержащие дисковые загрузчики написанные в СНГ.

   В последнее время для адресации порта #7FFD программисты используют команду OUT (#FD),A со сброшенным 7-м битом акку-
мулятора. На стандартном TURBO-2+ при дешифрации учитывается также разряд A9.
   Для лечения этой проблемы возьмите 555ЛЛ1, отогните у нее все ножки кроме 7 и 14 и напаяйте на любую 14 выводную мик-
росхему (так, чтобы припаяны были только выводы питания), далее аккуратно отпаяйте вывод 1 от дешифратора DD17 и включи-
те по следующей схеме:

   разрезать
             ┌──────X─────────┐
             │    1┌───┐      │
     A9 ─────┴─────┤1  │3     │
                  2│   ├──────┴─ к 1 выв. DD17
 RD (21 выв. z80)──┤ЛЛ1│
                   └───┘

   Теперь  A9 будет принимать участие в дешифрации портов только при активном сигнале RD (чтение портов ADRD,TLRD). Пос-
кольку  для  чтения из блока портов #xxFD (муз.процессора) всегда используется полная адресация, мы получаем полную сов-
местимость с пентагоном по портам!

                                               Проблема PC-XT клавиатуры.

   Некоторые процессоры 8031 очень неустойчиво работают с внешней синхронизацией. Поэтому, если у вас наблюдаются частые
сбои  при  работе с IBM-PC клавиатурой (залипание клавиш в SPECTRUM), сделайте следующую доработку. Отрежьте выводы 18 и
19 8031 и припаяйте к ним кварц 8-12 мгц (подобрать экспериментально) также припаяйте 2 конденсатора на землю (10-20 пф)
от выводов 18 и 19.

                                                        -= 6 =-

                                           Подключение HDD к платам Турбо 2+.

   Итак,  вы  решили приобрести винчестер для вашего компьютера. Прежде всего подумайте - а так ли уж он вам нужен? Т.к.
его можно использовать только в профессиональной ОС CP/M (мечта MicroARTa о сказочных возможностях загрузки программ для
SPECTRUMа  с HDD по всей видимости, так и останется мечтой). Хотя с нынешними ценами на IDE 20-40mb его может купить лю-
бой желающий.

   Ладно. Начнем с начала. Возьмите ваш HDD и подключите его шлейфом к плате (не перепутайте 1 и 40 контакты). Запустите
программу FDISK (продается в MicroARTe) и убедитесь в том, что параметры вашего HDD определяются программой. Если не оп-
ределяются - проверьте шлейф и схему интерфейса, поскольку при сборке эту схему никто не проверял.

   Не  рекомендуется использовать HDD более 40mb, т.к. ОС CP/M на TURBO 2+ позволяет разбить винт всего на 7 частей. По-
чему  cемь?  Потому,  что в диск-мониторе 10 каналов: 1 - электронный диск "A", 1 - дисковод "B", 1 - необходим для пра-
вильного функционирования копировщиков и форматеров (MFLX, например), остается 7 для вашего HDD. Почему не меньше - фай-
ловая система CP/M довольно тупа, и на поиск записи в директории затрачивает время прямо пропорциональное размеру дирек-
тории.  Hапример:  запуск  программки размером в 1кб с одного из разделов HDD емкостью 4mb - 7 секунд!!! Причем загрузка
этого килобайта - считанные милисекунды, все остальное время отнимает поиск в каталоге. А сканирование каталога этого же
раздела  в  XCOMANDERе  -  6 секунд !!! Из всего вышесказанного следует, что необходимо делать все разделы разной длинны
(большие - для хлама и игрушек, маленькие - для полезных системных программ).

   Рекомендуемая длина разделов:

C: 400 kbytes - для самых частозапускаемых программ (поверьте, этого хватит).
D: 1 mbytes    - для более редко используемых программ.
E:-I: Оставшееcя свободное место разделить поровну между этими дисками.

   Впишите выбранные вами размеры дисков в соответствующую колонку программы и сохраните ее на HDD (и на всякий случай -
на  дискете). Далее перезапустите компьютер и убедитесь в наличии в системе CP/M желаемых дисков. С помощью утилиты FOR-
MAT отформатируйте все диски, (те, что в дисководе, можно не форматировать :) ).

 Все что написано ниже имеет смысл делать если у вас 1024к озу!

   Для  исправления ошибок вам необходимо иметь программатор, подключенный к IBM или к SPECTRUM. Прочитайте ПЗУ и сохра-
ните ее в файле. Далее проделайте все необходимые изменения и запишите в другое пзу.

                                            Ошибка работы с RAM-DISK 1024k.

   При  установке  1024к  памяти возникает следующая проблема: в режиме CP/M при копировании информации в RAM-DISK после
переполнения  первых 416кб диска компьютер наглухо зависает, однако при запуске операционки он честно говорит: 1024 kby-
tes memory. HoneyComander работает совершенно нормально. Ошибка заключается в программе межстраничного переноса, которая
была  попросту  перенесена авторами с АТМ-1 (где 1024к в помине не было). Для устранения этого глюка необходимо в пзу (с
адреса  #C000 по #FFFF) найти комбинацию байт #6F,#C8,#CB,#7C,#3E,#03 (в версии 7.40 это адрес #D1EC) и заменить код #6F
на #7F. Работа в CP/M с электронным диском будет нормальная.

   Однако, после такого изменения компьютер обычно рисует красивую цветную надпись: "I cracked, I halted, press reset to
continue",  поскольку ПЗУ с BIOS защищена от изменений. Для снятия этой защиты в пзу с адреса #C000 по #FFFF (CP/M bios)
найдите  комбинацию  #01,#FF,#3F,#AF,#67,#6F,#86 (в версии 7.40 это адрес #C5BA) и замените #01 на #C9, далее необходимо
найти комбинацию #21,#00,#C0,#AF,#86,#CE,#00,#23 (в версии 7.40 это адрес #C1C7) и заменить #21 на #C9.Вы больше никогда
ни увидите разноцветной надписи + у вас появляется возможность редактировать TR-DOS.

                                                                                                        (c) 1995 MaxSoft

