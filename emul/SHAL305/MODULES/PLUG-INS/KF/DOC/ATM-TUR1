                                                        -= 1 =-
(C) MicroArt
(C) 1995 MaxSoft
                                           Персональный компьютер ATM-TURBO 1
                                                 Платы версии 4.10-4.50
                                    Техническое описание и руководство программиста.

                                        Структура памяти и портов ввода вывода.

                                                   1. Системный порт

                                                  Адрес доступа: #FDFD
                                             Выборка: A1=0,A9=0,A15=1,WR=0

D0 - EA16 \используется для переключения 4-х банков озу (512к)
D1 - EA17 /
D2 - RA16 выбирает какой банк пзу 27010 подключен
          "0" - BIOS+SP128+TR-DOS+SP48
          "1" - ROM DISK
D3 - CPNET "1"-в этом разряде информирует, что компьютер является сетевым при этом в режиме SPECTRUM, при попытке выхода
в TR-DOS мы попадаем по тому-же адресу, но в пзу с BIOS (в программу связи по сети, которую M-ART так и не написал ;-)).
Необходимо устанавливать в "0".
D4 - TON "1"-в этом разряде подключает эквивалент нагрузки к телефонной линии (снимает трубку). Необходимо устанавливать
в "0"
D5 - TNAB используется для набора номера телефона ("1"-линия замкнута "0"-разомкнута)


                                                  3. Порт SPECTRUM-128

                                                  Адрес доступа: #7FFD
                                             Выборка:A15=0,_A9=1_,A1=0,WR=0

D0-PAGE0  \
D1-PAGE1   > Определяют какая страница впечатана с адреса
D2-PAGE2  /  #C000 (выбор банка - см. порт #FDFD)
D3-SCREEN Этот разряд определяет в какой странице будет находится экранное озу.
       В режиме "SPECTRUM": 0- 5-я страница (с адреса #4000).
                            1- 7-я страница.
       в режиме CP/M:    0- 5-я страница точки, 1-я атрибуты.
                         1- 7-я страница точки, 3-я атрибуты.
D4-ROM2 Этот сигнал выбирает какая пзу подключена BASIC-128 (1) или BASIC-48 (0).
D5-LOCK  записав в этот разряд "1" мы запрещаем дальнейшую работу с портом #7FFD (это сделано для полной совместимости с
SPECTRUM-48).

                                 Карта памяти для различных режимов работы компьютера.
                             ┌─────┬────────────┬───────────┬────────┬──────────┬─────────┐
                             │mode │Spectrum-128│Spectrum-48│ TR-DOS │CPM-system│CPM-users│
                             │roms │   ROM2=1   │  ROM2=0   │   ROM2- значения не имеет   │
                             ├─────┼────────────┼───────────┼────────┼──────────┼─────────┤
                             │#0000│   ROM-2    │  ROM-3    │ ROM-1  │  ROM-0   │  RAM-0  │
                             │#4000│   RAM-5    │  RAM-5    │ RAM-5  │  RAM-5   │  RAM-4  │
                             │#8000│   RAM-2    │  RAM-2    │ RAM-2  │  RAM-2   │  RAM-2  │
                             │#C000│ см. состояние портов #7FFD #FDFD│RAM-1или 3│  RAM-3  │
                             └─────┴────────────┴───────────┴────────┴──────────┴─────────┘

В  режиме ZX-SPECTRUM в окне с адреса #C000 может быть влючена любая страница с 0 по #1F (это зависит от cостояния порта
#7FFD и 2-х младших бит #FDFD)
CPM-system  -  режим  когда  активно пзу с монитором (работа с экраном стандартные процедуры ввода/вывода с дисков,опрос
клавиатуры, прерывания)
CPM-users - режим когда активна программа пользователя (в окне 0 - страница 0 озу,в окне 1-страница 4)
При чтении из порта принтера шина A7 устанавливает состояние сигнала CPSYS этот сигнал служит для принудительного отклю-
чения  всех  возможных пзу SPECTRUM и подключения с адреса #0000 пзу с BIOS CP/M. (0-я часть 27512) IN A,(#7B) выключает
CPSYS (с адреса 0 подключается одно из пзу SPECTRUM) IN A,(#FB) включает CPSYS (с адреса 0 подключается пзу c CP/M-BIOS)


                                               4. Чтение телефонной линии

                                                  Адрес доступа: #7FFD
                                              Выборка:A15=0,A9=1,A1=0,RD=0

Так-же порт #7FFD доступен по чтению.
D0 - 1-указывает, что в телефонной линии есть сигнал вызова (звонка) остальные биты порта не задействованы.


                                                     5. Чтение АЦП.

                                                  Адрес доступа:#7DFD
                                              Выборка:A15=0,A9=0,A1=0,RD=0

Используется для чтения состояния АЦП. Если АЦП не закончило цикл преобразования данных, процессор притормажимается сиг-
налом WAIT.

                                                        -= 2 =-

                                          6. Порты музыкального сопроцессора.

                                               Адрес доступа:#BFFD,#FFFD
                                                Выборка:A15=1,A9=1,A1=0

Используются  для программирования музыкального синтезатора AY-8910(12). (см. описание "SPECTRUM-128 для пользователей и
программистов")

                                              7. Порт принтера и порт ЦАП.

                                                   Адрес доступа:#FB
                                                 Выборка:A0=1,A1=1,A2=0

На плате реализован стандартный интерфейс CENTRONIX. Он не требует ни какой предварительной инициализации.

Состояние сигналов при чтении:
D7 - состояние сигнала BUSY принтера.
D6 - Напряжение в телефонной линии 1- 60 вольт 0- > 15 вольт (линия занята)
A7 - сигнал CPSYS (cм. выше)

 Стандартный драйвер вывода на принтер символа из регистра C:

OUT_PRN:IN A,(#7B) ;(для СPM - #FB, иначе переключится пзу)
        RLCA
        RET  C    ;C FLAG =1 возврат (принтер не готов)
        LD   A,C
        OUT  (#FB),A ;выводим данные
        OUT  (#7B),A ;импульс строб
        OUT  (#FB),A ;сброс строба
        RET       ;C FLAG =0  байт послан

Необходимо помнить что к этому-же порту подключен цифро-аналоговый преобразователь.


                                           8. Интерфейсный порт ввода/вывода

                                                   Адрес доступа:#FA
                                                 Выборка:A0=0,A1=1,A2=0

Стробы  IOWR, IORD этого порта выведены на системный разъем компьютера, с помощью этого порта, и порта CENTRONIX к комп-
ьютеру  можно  подключить  256 устройств ввода и 256 устройств вывода, при сохранении полной совместимости с оригиналом.
При  этом,  адрес  порта записывается в CENTRONIX по команде OUT (#FB),A а данные считываются по команде IN A,(#FA), или
записываются по команде OUT (#FA),A. Шина данных на разъеме буферизированна. Для сохранения совместимости все новые раз-
работки рекомендуется подключать используя исключительно этот порт.


                                                   9. Запись палитры
                                                  Адрес доступа:#7DFD
                                                Выборка: A15=0,A9=0,A1=0

Код  цвета,  палитру  которого вы хотите установить должен быть выставлен на порте BORDER (не забудьте о 3-м (инверсном)
бите  цвета, который должен передаваться через шину A3). Для того чтобы бордюр не мигал, запись необходимо синхронизиро-
вать с прерываниями. Число записываемое в порт #7DFD должно нести в битах 0-5 информацию об интенсивности bgrBGR состав-
ляющей для данного цвета. Для каждого луча R,G,B можно задать 4 интенсивности.

                                                  10. Порт клавиатуры
                                                   Адрес доступа:#FE
                                              Выборка:A0=0,A1=1,A2=1,RD=0

D0 -KD1\
D1 -KD2 \
D2 -KD3  клавиатурные входы данных
D3 -KD4 /
D4 -KD5/
D5 -ADD чтение 1-битного сигнала из телефонной линии.
D6 -TIN Сигнал чтения с магнитофона.
D7 -Z Системный сигнал от ПЛМ, На этом сигнале построена защита от копирования плат. Сигнал активизируется через опреде-
ленное количество тактов после прихода прерывания (точно не помню какое). Программа, подсчитывая это количество, получа-
ет байт, который является ключем распаковки из пзу BIOSа и BDOSа.

A8 -KA0\
A9 -KA1 \
A10-KA2  \
A11-KA3   \ адресные линии клавиатуры
A12-KA4   /
A13-KA5  /
A14-KA6 /
A15-KA7/

                                                        -= 3 =-

                                                    11. Порт бордюра

                                                   Адрес доступа:#FE
                                              Выборка:A0=0,A1=1,A2=1,WR=0

Этот порт несколько отличается от стандартного SPECTRUM. Дело в том что в CP/M бордюр (как и экран) может иметь любой из
шестнадцати  цветов  (из палитры 64) поэтому потребовался дополнительный бит цвета, который был заведен на инверсный A3.
Так-же на этот порт заведено несколько новых сигналов расширения, что очень мешает совместимости компьютера c фирменным.

D0-BRD0\
D1-BRD1 цвет бордюра
D2-BRD2/
D3-TAPEOUT Выход на магнитофон
D4-SOUND   Выход на динамик
D5-не используется
D6-не используется
D7-не используется
A3-BRD3 - 3-й бит цвета (инверсный)
A5-RG1  \
A6-RG0  /определяет видеорежим экрана (см. ниже)
A7-CPUS  0- в этом разряде отключает пзу и вместо него подключает 0-ю страницу озу, при этом с адреса #4000 подключается
4-я страница озу (вместо стандартно включенной 5-й). Это необходимо для нормального функционирования CP/M.

 Режимы экpана:
RG0=1 & RG1=0 - запpещенное состояние
RG0=0 & RG1=0 - 320x200 точек
RG0=0 & RG1=1 - 640x200 точек
RG0=1 & RG1=1 - экpан Sinclair

Программистам  необходимо помнить, что при переключении из режима Sinclair экрана и экранов высокого разрешения, перепу-
тывается  адресное  пространство  озу а именно A5,A6,A7 и A8,A9,A10 соответственно т.е. если вы хотите переключить режим
экрана  -  программа  переключения  должна  занимать не более 32 байт и располагаться по адресу с одинаковыми A5,A6,A7 и
A8,A9,A10 соответственно, иначе ваша программа зависнет!

                                                Аппаратные ошибки платы.

   На плате АТМ-TURBO 1 используется очень неудобная адресация дополнительных портов конфигурации.
   Ошибка 1 - Переключение режимов экрана совмещено с портом #FE. Что приводит к неработоспособности программ защищенных
ANTON  PROTECTION  SYSTEM,DIMAN  PROTECTION  SYSTEM!  а  так-же  других где команда OUT (#FE),A дублируется командой OUT
(#3E),A  Это приводит к смене видеорежима и адресации памяти (признаком является беспорядочная цветная картинка в режиме
высокого разрешения).

Например не работают:
LYRA-2/9 (disk version by Vasilyev Anton)
SONG'LN5 (disk version by Softstar)
......

   Ошибка  2 - использование при дешифрации порта #7FFD и портов муз-процессора адреса A9. В последнее время для адреса-
ции  порта #7FFD программисты используют команду OUT (#FD),A с сброшенным 7 битом аккумулятора! Но для ATM-TURBO 1 необ-
ходимо наличие "1" на A9.

Из за этого не идут следующие программы:

STS debuger-monitor,
SHOCK MEGADEMO,
INSULT MEGADEMO,
игрушка RONDLAND,
ASM v1.03 и выше,
FARLIGHT-2
и многие другие игрушки и программы, содержащие дисковые загрузчики, написанные в СНГ.


   Ошибка 3 - микросхема ВГ93 не работает в режиме турбо!

   Способ  доработки  описанный в документации M-ART (на 1мс. 555кп12) помогает в лечении 1-й проблемы, но не решает 2-ю
(тем  более  3-ю),  так-же  перестает  работать  такая  прекрасная  программа как Honey Comander (теряются функции RESI-
DENT,RAM-DISK  512k), кнопка Турбо работает только в CP/M. Ниже предлагается мой собственный способ решения всех 3 проб-
лем, при котором в HC работают все функции + получаем почти 100% Пентагон-совместимую машину (кроме прерываний и мульти-
колора).

   Для этого необходимо:

1) аккуратно отпаять и отогнуть следующие выводы мс: 1.D17,3.D69
2) откусить от микросхемы D50 выводы 2,3,4,5,6,7 (по самый корпус).
3)  взять  новую мс. 555ТМ9 откусить выводы 10,11,12,13,14,15 и напаять на D50 так, что-бы выводы 2,3,4,5,6,7 попадали в
соответствующие отверстия от D50, выводы 1,8,16 были замкнуты с соответствующими выводами D50 (а вывод 9 пока отогните).
4) соберите схему


                                                        -= 4 =-

              555ТМ2
+5v         1┌──┬────┐5       LOCKP
 │    RES ───x R│tt Q├─────────────
┌┴┐         2├──┤    │
│ │   RG0 ───┤ D│    │
└┬┘2ком     3│  │    │
 ├───────────┤ C│    │
 │          4├──┤    │6
 │       +5v─x S│   Qx──
 │           └──┴────┘
 │  ─┴─  кнопка LOCK
 ├─── ─┬──────── gnd
 └┤├───┘
     68нф

             ┌──────X─────────┐
             │    1┌───┐      │
     A9 ─────┴─────┤1  │3     │
                  2│   ├──────┴─ к 1 выв. D17
            LOCKP──┤ЛЛ1│
                   └───┘
             разрезать
             ┌──────X─────────┐
             │    4┌───┐      │
     /PRRD───┴─────┤1  │6     │
                  5│   ├──────┴─ к 3 выв. D69
            LOCKP──┤ЛЛ1│
                   └───┘
                  9┌───┐
     /BRDWR────────┤1  │8
                 10│   ├──────── к 9 выв. напаянной сверху
            LOCKP──┤ЛЛ1│             D50ТМ9
                   └───┘

   А теперь вкратце о том как это работает. При включении компьютера триггер сбрасывается сигналом RESET, сигнал LOCKP=0
и  доступ  во  все порты разрешен. Если мы работаем в CP/M - нажатие кнопки ни к чему не приводит т.к. RG0=0. В SPECTRUM
ситуация  иная  RG0=1 и нажатие кнопки приводит к защелкиванию RG0 в триггер и теперь LOCKP=1, доступ к всем портам CP/M
запрещен.
   И  так вы запускаете программу (например из HC) и программа зависает! Нажмите Reset (чтобы вернутся в Honey Comander)
и  запустите  программу  снова.  Но теперь, как только программа начнет загружаться (это нужно то-бы HC успел установить
свою резидентную часть), нажмите на кнопку LOCK. Программа заработает. (если вы не используете HC, после выхода в SPECT-
RUM просто нажмите кнопку LOCK).
   Кнопка LOCK не фиксируемая - достаточно 1 раз нажать ее в режиме Spectrum и до следующего RESET любая программа будет
определять его как PENTAGON 128.

   А теперь о доработке для работы ВГ93 в турбо режиме.
   Здесь ничего нового не изобретено (схема просто взята с TURBO2+), используется 1мс. (555ла3) и оставшийся от предыду-
щей доработки элемент лл1.
   Необходимо перерезать дорожку идущую от 3 вывода D75.

                   разрезать
       ┌─────────────X────────────┐
       │   13┌───┐      10┌───┐   │
D75.3──┴─────┤&  │11    ┌─┤&  │8  │
           12│   o──────┤9│   o───┴── к 24 выв. D1
          ┌──┤ЛА3│      └─┤ЛА3│
          │  └───┘        └───┘
          └───────────────────────────────────────┐
        1┌───┐            4┌───┐        12 ┌───┐  │
D89.3  ┌─┤&  │3          ┌─┤&  │6  ┌───────┤1  │11│
VGCS ──┤2│   o──┤├────┬──┤5│   o───┘     13│   ├──┘
       └─┤ЛА3│  220пф┌┴┐ └─┤ЛА3│     TRB───┤ЛЛ1│
         └───┘       │ │   └───┘   D61.4   └───┘
                     └┬┘ 3ком
                     ─┴─

                                                                                